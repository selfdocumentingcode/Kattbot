name: Release

on:
  workflow_dispatch:
    inputs:
      updateDatabase:
        description: 'Update database (allowed values: no, auto, manual)'
        required: false
        default: 'no'
        
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Replace tokens in appsettings
      uses: cschleiden/replace-tokens@v1
      with:
        tokenPrefix: '__'
        tokenSuffix: '__'
        files: 'Kattbot/appsettings.json'
      env:
        CONNECTION_STRING: ${{secrets.DB_CONNECTION_STRING}}
        BOT_TOKEN: ${{secrets.BOT_TOKEN}}
        OPENAI_API_KEY: ${{secrets.OPENAI_API_KEY}}
    
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Test
      run: dotnet test
    
    - name: Publish
      run: dotnet publish -c Release -r linux-x64 -o publish-output --no-self-contained ./Kattbot/

    - name: Generate database migration script
      if: github.event.inputs.updateDatabase == 'auto' || github.event.inputs.updateDatabase == 'manual'
      run: |
        dotnet tool install --global dotnet-ef
        dotnet tool restore
        dotnet ef migrations script --idempotent -p Kattbot.Data.Migrations -o publish-output/database_migration.sql
      env:
        DOTNET_ENVIRONMENT: Production

    - name: Copy publish output to staging folder
      uses: appleboy/scp-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        source: "publish-output/"
        target: "$HOME/kattbot-staging"
        strip_components: 1
        rm: true
        
    - name: Copy deploy scripts to deploy folder
      uses: appleboy/scp-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        source: "deploy/"
        target: "$HOME/kattbot-deploy"
        strip_components: 1
        rm: true
    
    - name: Deploy - Stop service
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: systemctl --user stop --quiet kattbot || true
    
    - name: Deploy - Prepare deploy scripts
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: chmod +x $HOME/kattbot-deploy/*.sh
        
    - name: Deploy - Run deploy script
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: $HOME/kattbot-deploy/kattbot-deploy.sh

    - name: Deploy - Backup database
      if: github.event.inputs.updateDatabase == 'auto' || github.event.inputs.updateDatabase == 'manual'
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: $HOME/kattbot-deploy/kattbot-backup-db.sh
 
    - name: Deploy - Run database migration script
      if: github.event.inputs.updateDatabase == 'auto'
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: psql -U "kattbot-user" -d kattbot -q -f $HOME/kattbot/database_migration.sql
 
    - name: Deploy - Start service
      if: github.event.inputs.updateDatabase == 'no' || github.event.inputs.updateDatabase == 'auto'
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: systemctl --user enable kattbot && systemctl --user start kattbot
