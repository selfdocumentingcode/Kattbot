name: Release

on:
  workflow_dispatch:
    inputs:
      updateDatabase:
        description: 'Update database (allowed values: no, auto, manual)'
        required: false
        default: 'no'
        
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Replace tokens in appsettings
      uses: cschleiden/replace-tokens@v1
      with:
        tokenPrefix: '__'
        tokenSuffix: '__'
        files: 'Kattbot/appsettings.json'
      env:
        CONNECTION_STRING: ${{secrets.DB_CONNECTION_STRING}}
        BOT_TOKEN: ${{secrets.BOT_TOKEN}}
    
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Test
      run: dotnet test
    
    - name: Publish
      run: dotnet publish -c Release -r linux-x64 -o publish-output --no-self-contained ./Kattbot/

    - name: Generate database migration script
      if: github.event.inputs.updateDatabase == 'auto' || github.event.inputs.updateDatabase == 'manual'
      run: |
        dotnet tool install --global dotnet-ef
        dotnet tool restore
        dotnet ef migrations script --idempotent -p Kattbot.Data.Migrations -o publish-output/database_migration.sql
      env:
        DOTNET_ENVIRONMENT: Production
    
    - name: List dir
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: 'pwd && ls -lA && echo workspacedir: $GITHUB_WORKSPACE'

    - name: Copy publish output to staging folder
      uses: appleboy/scp-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        source: "/home/runner/work/Kattbot/Kattbot/publish-output/"
        target: "/home/${{secrets.KATTBOT_USER}}/kattbot-staging"
        rm: true
    
    - name: List dir 2
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: 'ls $HOME'
        
    #- name: Copy deploy scripts to deploy folder
    #  uses: appleboy/scp-action@master
    #  with:  
    #    host: ${{secrets.VPS_HOST_NEW}}
    #    port: ${{secrets.VPS_PORT}}
    #    username: ${{secrets.KATTBOT_USER}}
    #    key: ${{secrets.KATTBOT_KEY}}
    #    passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
    #    source: "/home/runner/work/Kattbot/Kattbot/deploy/"
    #    target: "/home/${{secrets.KATTBOT_USER}}/kattbot-deploy"
    #    rm: true
    
    - name: Deploy - Stop service
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: systemctl --user stop kattbot &> /dev/null
    
    - name: Deploy - Run deploy script
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: /home/${{secrets.KATTBOT_USER}}/kattbot-deploy/kattbot-deploy.sh
 
    #- name: Deploy - Change Kattbot permission
    #  uses: appleboy/ssh-action@master
    #  with:  
    #    host: ${{secrets.VPS_HOST_NEW}}
    #    port: ${{secrets.VPS_PORT}}
    #    username: ${{secrets.KATTBOT_USER}}
    #    key: ${{secrets.KATTBOT_KEY}} 
    #    script: sudo chmod 777 /home/${{secrets.KATTBOT_USER}}/kattbot/Kattbot

    - name: Deploy - Backup database
      if: github.event.inputs.updateDatabase == 'auto' || github.event.inputs.updateDatabase == 'manual'
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: /home/${{secrets.KATTBOT_USER}}/kattbot-backup-db.sh
 
    - name: Deploy - Run database migration script
      if: github.event.inputs.updateDatabase == 'auto'
      uses: appleboy/ssh-action@master
      with:  
        host: ${{secrets.VPS_HOST_NEW}}
        port: ${{secrets.VPS_PORT}}
        username: ${{secrets.KATTBOT_USER}}
        key: ${{secrets.KATTBOT_KEY}}
        passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
        script: psql -U postgres -d kattbot -q -f /home/${{secrets.KATTBOT_USER}}/kattbot/database_migration.sql
 
    #- name: Deploy - Start service
    #  if: github.event.inputs.updateDatabase == 'no' || github.event.inputs.updateDatabase == 'auto'
    #  uses: appleboy/ssh-action@master
    #  with:  
    #    host: ${{secrets.VPS_HOST_NEW}}
    #    port: ${{secrets.VPS_PORT}}
    #    username: ${{secrets.KATTBOT_USER}}
    #    key: ${{secrets.KATTBOT_KEY}}
    #    passphrase: ${{secrets.KATTBOT_PASSPHRASE}}
    #    script: systemctl --user start kattbot
